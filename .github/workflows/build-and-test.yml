  build-and-test:
    name: Build & Unit Tests
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
      - name: 📥 Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: 🔧 Setup JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'
      
      - name: 🔨 Build and Run Unit Tests
        run: |
          mvn clean test -B -Dspring.profiles.active=test -e 2>&1 | tee test-output.log
        continue-on-error: true
      
      - name: 🔍 Display Full Test Errors
        if: always()
        run: |
          echo "================================"
          echo "FULL TEST OUTPUT"
          echo "================================"
          cat test-output.log
          echo ""
          echo "================================"
          echo "SUREFIRE REPORTS"
          echo "================================"
          for file in target/surefire-reports/*.txt; do
            if [ -f "$file" ]; then
              echo "=== $file ==="
              cat "$file"
              echo ""
            fi
          done
      
      - name: 📤 Upload Full Error Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: full-test-logs
          path: |
            test-output.log
            target/surefire-reports/
          retention-days: 7
      
      - name: ✅ Verify Test Success
        if: success()
        run: |
          echo "================================"
          echo "✅ All unit tests passed successfully!"
          echo "================================"
      
      - name: 📊 Generate Test Report
        if: always()
        uses: dorny/test-reporter@v1
        continue-on-error: true
        with:
          name: Unit Test Results
          path: target/surefire-reports/*.xml
          reporter: java-junit
          fail-on-error: false
      
      - name: 📤 Upload Unit Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results
          path: |
            target/surefire-reports/
            target/site/jacoco/
          retention-days: 30
      
      - name: 📦 Package Application
        if: success()
        run: mvn package -DskipTests -B
      
      - name: 📤 Upload JAR Artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: application-jar
          path: target/*.jar
          retention-days: 7

